<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Tracker</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
        }

        header {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 1em;
        }

        #portfolio-container {
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #333;
            color: white;
        }

        tr:hover td:not(:nth-child(5)) {
            background-color: #f5f5f5;
        }

        form {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
        }

        form input {
            padding: 8px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        form button {
            padding: 8px 16px;
            background-color: #333;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
     
        td:nth-child(5) { /* 'x' button column */
            width: 5px;
            padding: 0;
            border: none;
        }

        td button {
            /* Style the buttons to look like buttons */
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1em;
            margin-left: 0.2em;
            margin-right: 0.2em; /* Adjusted margin for closer spacing between buttons */    
            padding: 0.2em 0.5em;
            transition: background-color 0.3s ease;
            border-radius: 4px; /* Added border-radius for a rounded button appearance */
        }

        td button.x {
            /* Style the 'x' button specifically */
            background-color: #dc3545;
            border: none; /* Invisible border for 'x' button */
        }

        button#refreshButton {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        div#addressContainer {
            display: none;
        }
    </style>
</head>
<body>
    <header>
        <h1>Portfolio Tracker</h1>
    </header>
    <button type="button" onclick="refreshPrices()">Refresh Prices</button>
    <div id="portfolio-container">
        <table>
            <thead>
                <tr>
                    <th>Asset</th>
                    <th>Quantity</th>
                    <th>Price</th>
                    <th>Total Value (USD)</th>
                </tr>
            </thead>
            <tbody id="portfolio-body">
                <!-- Portfolio data will be displayed here dynamically -->
            </tbody>
        </table>

        <form id="addAssetForm">
            <input type="text" id="assetInput" placeholder="Asset">
            <input type="number" id="quantityInput" placeholder="Quantity">
            <div id="addressContainer" style="display: none;"> <!-- Hidden by default -->
                <input type="text" id="addressInput" placeholder="Address">
            </div>
            <button type="button" onclick="toggleAddress()">Crypto</button>
            <button type="button" onclick="addAsset()">Add Asset</button>
        </form>
    </div>

    <script>
        // Function to fetch and display portfolio data
        async function fetchPortfolioData() {
            const response = await fetch('/api/portfolio');
            const data = await response.json();

            const portfolioBody = document.getElementById('portfolio-body');
            portfolioBody.innerHTML = '';

            // Create an array to store promises for calculating total values
            const totalValuePromises = data.map(asset => updateTotalValue(asset));
            const pricePromises = data.map(asset => updatePrice(asset));
            // Wait for all total value calculations to complete
            const totalValues = await Promise.all(totalValuePromises);
            const price = await Promise.all(pricePromises);
            // Iterate through data and create rows with total values
            data.forEach((asset, index) => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `<td>${asset.asset}</td>
                <td>${asset.quantity}</td>
                <td id="price_${asset.asset}">${price[index]}</td>
                <td id="totalValue_${asset.asset}">${totalValues[index]}</td>
                <td><button class="x" onclick="removeAsset('${asset.asset}')">x</button></td>`;
                portfolioBody.appendChild(newRow);
            });
        }
        // Function to calculate total value
        // Function to calculate total value using Etherplorer's API
        async function calculateTotalValue(asset) {
            if (asset.address) {
                try {
                    const apiKey = 'EK-pyu1H-XEfn7of-5JyhC'; // Replace with your actual Etherplorer API key
                    const contractAddress = asset.address.toLowerCase(); // Convert to lowercase as Etherplorer API requires it
                    // Validate the Ethereum address format
                    if (!isValidEthereumAddress(contractAddress)) {
                        console.error('Invalid Ethereum address format:', contractAddress);
                        return 'Error';
                    }

                    // Make a request to get the token information including the price
                    const tokenInfoResponse = await fetch(`https://api.ethplorer.io/getTokenInfo/${contractAddress}?apiKey=${apiKey}`);
                    const tokenInfoData = await tokenInfoResponse.json();

                    const tokenInfoResponseBNB = await fetch(`https://api.binplorer.com/getTokenInfo/${contractAddress}?apiKey=${apiKey}`);
                    const tokenInfoDataBNB = await tokenInfoResponseBNB.json();
                    // Check if the API response indicates success
                    
                    if(tokenInfoData.error){
                        const tokenPrice = tokenInfoDataBNB.price.rate;

                        // Calculate the value based on the fetched token price
                        const totalValue = calculateTokenValue(asset.quantity, tokenPrice);
                        const vals = [totalValue.toFixed(2), tokenPrice]
                        return vals; // Return the value with 2 decimal places

                    }else{
                        const tokenPrice = tokenInfoData.price.rate;

                        // Calculate the value based on the fetched token price
                        const totalValue = calculateTokenValue(asset.quantity, tokenPrice);
                        const vals = [totalValue.toFixed(2), tokenPrice]
                        return vals; // Return the value with 2 decimal places
                    }
                } catch (error) {
                    // Display an error message
                    console.error('Error fetching token details from Etherplorer:', error.message);
                    return 'Error';
                }
            }

            // If no address is provided, calculate total value based on quantity and price
            return (asset.quantity * asset.price).toFixed(2);
        }
        async function refreshPrices() {
            // Fetch and display updated portfolio data
            await fetchPortfolioData();
        }
        // Function to validate Ethereum address format
        function isValidEthereumAddress(address) {
            const regex = /^(0x)?[0-9a-fA-F]{40}$/;
            return regex.test(address);
        }
        function calculateTokenValue(quantity, rate) {
            return quantity * rate;
        }
        async function updateTotalValue(asset) {
            const totalValue = await calculateTotalValue(asset);
            const totalValueCell = document.getElementById(`totalValue_${asset.asset}`);
            
            if (totalValueCell) {
                totalValueCell.innerText = totalValue[0];
            }
            
            return totalValue[0];
        }
        async function updatePrice(asset) {
            const price = await calculateTotalValue(asset);
            const priceCell = document.getElementById(`price_${asset.asset}`);
            
            if (priceCell) {
                priceCell.innerText = price[1];
            }
            
            return price[1];
        }

        function toggleAddress() {
            const addressContainer = document.getElementById('addressContainer');
            const addressHeader = document.getElementById('addressHeader');

            // Toggle the visibility of the address input and header
            if (addressContainer.style.display === 'none') {
                addressContainer.style.display = 'block';
                addressHeader.style.display = 'table-cell';
            } else {
                addressContainer.style.display = 'none';
                addressHeader.style.display = 'none';
            }
        }
        // Function to add an asset
        async function addAsset() {
            const asset = document.getElementById('assetInput').value;
            const quantity = document.getElementById('quantityInput').value;
            const addressContainer = document.getElementById('addressContainer');
            const address = addressContainer.style.display === 'none' ? '' : document.getElementById('addressInput').value;

            if (!asset || !quantity) {
                alert('Please fill in all fields');
                return;
            }

            const response = await fetch('/api/portfolio', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ asset, quantity, address }),
            });

            const data = await response.json();
            fetchPortfolioData();
        }
    
        // Function to remove an asset
        async function removeAsset(asset) {
            const confirmed = confirm(`Are you sure you want to remove "${asset}" from your portfolio?`);
            if (confirmed) {
                const response = await fetch(`/api/portfolio/${encodeURIComponent(asset)}`, { method: 'DELETE' });
                const data = await response.json();
                fetchPortfolioData();
            }
        }

    
        // Fetch initial data
        fetchPortfolioData();
    </script>
</body>
</html>
